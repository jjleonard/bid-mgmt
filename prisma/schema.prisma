generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

model Bid {
  id         String    @id @default(cuid())
  clientName String
  bidName    String
  status     BidStatus
  opportunityType OpportunityType @default(single_tender)
  currentStage BidStage?
  nextStageDate DateTime?
  psqReceivedAt DateTime?
  psqClarificationDeadlineAt DateTime?
  psqSubmissionDeadlineAt DateTime?
  psqSubmissionTime String?
  ittReceivedAt DateTime?
  ittClarificationDeadlineAt DateTime?
  ittSubmissionDeadlineAt DateTime?
  ittSubmissionTime String?
  tcvGbp Int?
  initialTermMonths Int?
  extensionTermMonths Int?
  tcvTermBasis TcvTermBasis?
  annualValueGbp Int?
  portalUrl String?
  folderUrl  String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  auditEvents AuditEvent[]
}

model AuditEvent {
  id        String       @id @default(cuid())
  bidId     String?
  bidIdSnapshot String?
  bidLabel  String?
  action    String       @default("update")
  actor     String       @default("system")
  createdAt DateTime     @default(now())
  bid       Bid?         @relation(fields: [bidId], references: [id], onDelete: SetNull)
  changes   AuditChange[]
}

model AuditChange {
  id        String     @id @default(cuid())
  eventId   String
  field     String
  fromValue String
  toValue   String
  createdAt DateTime   @default(now())
  event     AuditEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
}

model User {
  id           String   @id @default(cuid())
  firstName    String
  surname      String
  email        String   @unique
  role         Role
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  sessions     Session[]
  passwordResets PasswordResetToken[]
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime
  usedAt    DateTime?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PasswordResetRequest {
  id        String   @id @default(cuid())
  email     String
  ipAddress String?
  createdAt DateTime @default(now())
}

model AppBranding {
  id             Int      @id @default(1)
  companyName    String?
  companyWebsite String?
  supportEmail   String?
  logoPath       String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

enum BidStatus {
  pending
  pipeline
  in_progress
  bid
  no_bid
  submitted
  won
  lost
  dropped
  abandoned
}

enum OpportunityType {
  single_tender
  combined_psq_itt
  two_stage_psq_itt
}

enum BidStage {
  psq
  itt
}

enum TcvTermBasis {
  initial_only
  initial_plus_extension
}

enum Role {
  engineer
  supervisor
  bids
  admin
}
